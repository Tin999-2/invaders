<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Space Invaders - Final Form</title>
    <style>
        body {
            background-color: #010103; color: #fff;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
        }
        #ui-container { width: 1400px; display: flex; flex-direction: column; align-items: center; padding: 10px 0; z-index: 10; }
        #score-display {
            font-size: 80px; font-weight: 900; color: #00f3ff;
            text-shadow: 0 0 20px #00f3ff, 0 0 40px #00f3ff; margin-bottom: -10px;
        }
        #lives-display { font-size: 24px; color: #FF0055; text-shadow: 0 0 10px #FF0055; align-self: flex-start; }
        canvas { border: 4px solid #1a1a2e; background-color: #000; box-shadow: 0 0 60px rgba(0, 243, 255, 0.2); }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.92); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .complete-text { color: #00FF66; font-size: 120px; text-shadow: 0 0 50px #00FF66; font-weight: bold; }
        .keyword-text { color: #fff; font-size: 50px; margin: 30px 0 60px; text-shadow: 0 0 20px #fff; letter-spacing: 5px; }
        .gameover-text { color: #FF0055; font-size: 120px; text-shadow: 0 0 50px #FF0055; font-weight: bold; }
        .btn { 
            background: transparent; border: 4px solid #00f3ff; color: #00f3ff; 
            padding: 20px 80px; font-size: 32px; cursor: pointer; transition: 0.3s;
            font-family: inherit; font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }
        .btn:hover { background: #00f3ff; color: #000; box-shadow: 0 0 40px #00f3ff; }
    </style>
</head>
<body>

<div id="ui-container">
    <div id="score-display">000000</div>
    <div id="lives-display">LIVES: <span id="lives">3</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="completeScreen" class="overlay">
    <div class="complete-text">COMPLETE</div>
    <div class="keyword-text">Keyword : Space</div>
    <button class="btn" onclick="resetGame()">RETRY</button>
</div>

<div id="gameOverScreen" class="overlay">
    <div class="gameover-text">GAME OVER</div>
    <button class="btn" onclick="resetGame()">TRY AGAIN</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-display');
    const livesEl = document.getElementById('lives');

    canvas.width = 1400;
    canvas.height = 1100;

    let score = 0, lives = 3, gameActive = true, lastUfoSpawn = Date.now();
    let particles = [];
    let bgmStarted = false;

    const bgm = new Audio('assets/sounds/in-your-world.mp3');
    bgm.loop = true;
    let audioCtx = null;
    let ufoOsc = null, ufoGain = null, ufoLfo = null;

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (!bgmStarted && gameActive) { bgm.play().catch(e => {}); bgmStarted = true; }
    }

    function playExplosionSound() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.2);
    }

    function playPlayerExplosionSound() {
        const noise = audioCtx.createBufferSource();
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.8, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
        noise.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(400, audioCtx.currentTime);
        filter.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.8);
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
        noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
        noise.start();
    }

    function startUfoSound() {
        if (!audioCtx || ufoOsc) return;
        ufoOsc = audioCtx.createOscillator(); ufoLfo = audioCtx.createOscillator();
        const lfoGain = audioCtx.createGain(); ufoGain = audioCtx.createGain();
        ufoOsc.type = 'sine'; ufoOsc.frequency.setValueAtTime(500, audioCtx.currentTime);
        ufoLfo.frequency.setValueAtTime(10, audioCtx.currentTime);
        lfoGain.gain.setValueAtTime(100, audioCtx.currentTime);
        ufoLfo.connect(lfoGain); lfoGain.connect(ufoOsc.frequency);
        ufoGain.gain.setValueAtTime(0, audioCtx.currentTime);
        ufoGain.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.5);
        ufoOsc.connect(ufoGain); ufoGain.connect(audioCtx.destination);
        ufoOsc.start(); ufoLfo.start();
    }

    function stopUfoSound() {
        if (ufoOsc) {
            ufoGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            const o = ufoOsc, l = ufoLfo;
            setTimeout(() => { o.stop(); l.stop(); }, 100);
            ufoOsc = null; ufoLfo = null;
        }
    }

    function createExplosion(x, y, color, size = 1) {
        for (let i = 0; i < 40 * size; i++) {
            particles.push({
                x, y, vx: (Math.random() - 0.5) * 15 * size, vy: (Math.random() - 0.5) * 15 * size,
                alpha: 1, decay: 0.01 + Math.random() * 0.02, color
            });
        }
    }

    const player = { width: 80, height: 45, x: 700 - 40, y: 1000, color: '#00f3ff', alive: true };
    let bullets = [], enemyBullets = [], ufo = { x: -150, y: 70, w: 90, h: 40, active: false, speed: 6, color: '#FF1493' };
    let aliens = [], alienDir = 1, alienSpeed = 0.5, stars = [];

    function initAliens() {
        aliens = [];
        for (let r = 0; r < 4; r++) {
            for (let c = 0; c < 8; c++) {
                let color, pts, type, w, h;
                if (r === 0) { 
                    color = '#FF3333'; pts = 30; type = 'tiny'; w = 40; h = 30; // 最上段：さらに小さい新タイプ
                } else if (r === 1) { 
                    color = '#33FF33'; pts = 20; type = 'mid'; w = 50; h = 35; // 2段目：変更なし
                } else { 
                    color = (r === 2) ? '#3333FF' : '#FFFF33'; pts = 10; type = 'special'; w = 50; h = 35; // 3・4段目：以前の最上段の形
                }
                // 中央寄せのためのオフセット計算（最大幅50を基準）
                const xOffset = (50 - w) / 2;
                aliens.push({ x: 420 + c * 80 + xOffset, y: 180 + r * 60, w: w, h: h, color, points: pts, type, alive: true });
            }
        }
        alienSpeed = 0.5;
    }

    function drawAlienShape(a) {
        ctx.fillStyle = a.color;
        ctx.shadowBlur = 15; ctx.shadowColor = a.color;
        const x = a.x, y = a.y, w = a.w, h = a.h;

        if (a.type === 'tiny') {
            // 最上段：もっと小さい新しい形
            ctx.fillRect(x + w*0.2, y, w*0.6, h*0.3); 
            ctx.fillRect(x, y + h*0.3, w, h*0.4);     
            ctx.fillRect(x + w*0.1, y + h*0.7, w*0.2, h*0.3); 
            ctx.fillRect(x + w*0.7, y + h*0.7, w*0.2, h*0.3);
        } else if (a.type === 'special') {
            // 3・4段目：以前の最上段の形
            ctx.fillRect(x + w*0.3, y, w*0.4, h*0.2); 
            ctx.fillRect(x, y + h*0.2, w, h*0.5);                  
            ctx.fillRect(x + w*0.2, y + h*0.7, w*0.1, h*0.3); 
            ctx.fillRect(x + w*0.7, y + h*0.7, w*0.1, h*0.3);
        } else {
            // 2段目：変更なし (Mid)
            ctx.fillRect(x, y, w*0.2, h*0.3); ctx.fillRect(x + w*0.8, y, w*0.2, h*0.3);  
            ctx.fillRect(x + w*0.1, y + h*0.2, w*0.8, h*0.6); 
            ctx.fillRect(x + w*0.2, y + h*0.8, w*0.2, h*0.2); ctx.fillRect(x + w*0.6, y + h*0.8, w*0.2, h*0.2);
        }
        
        ctx.shadowBlur = 0; ctx.fillStyle = '#000';
        ctx.fillRect(x + w*0.25, y + h*0.3, w*0.12, h*0.12); ctx.fillRect(x + w*0.63, y + h*0.3, w*0.12, h*0.12);
    }

    function initStars() {
        stars = [];
        for (let i = 0; i < 200; i++) stars.push({ x: Math.random() * 1400, y: Math.random() * 1100, s: Math.random() * 2, v: Math.random() * 2 + 1 });
    }

    document.addEventListener('keydown', e => { 
        initAudio(); 
        if (!player.alive) return;
        if (e.key === 'ArrowLeft') player.dx = -10; 
        if (e.key === 'ArrowRight') player.dx = 10; 
        if (e.key === ' ' && gameActive) { if (bullets.length < 2) bullets.push({ x: player.x + 36, y: player.y }); }
    });
    document.addEventListener('keyup', () => player.dx = 0);

    function update() {
        if (!gameActive) return;
        stars.forEach(s => { s.y += s.v; if (s.y > 1100) s.y = 0; });
        if (player.alive) player.x = Math.max(0, Math.min(1320, player.x + (player.dx || 0)));

        if (!ufo.active && Date.now() - lastUfoSpawn > 10000) { ufo.active = true; ufo.x = -150; startUfoSound(); lastUfoSpawn = Date.now(); }
        if (ufo.active) { ufo.x += ufo.speed; if (ufo.x > 1500) { ufo.active = false; stopUfoSound(); } }

        bullets.forEach((b, i) => { 
            b.y -= 15; if (b.y < -20) bullets.splice(i, 1);
            aliens.forEach(a => {
                if (a.alive && b.x < a.x + a.w && b.x + 8 > a.x && b.y < a.y + a.h && b.y + 20 > a.y) {
                    a.alive = false; bullets.splice(i, 1); score += a.points;
                    scoreEl.innerText = score.toString().padStart(6, '0');
                    createExplosion(a.x + a.w/2, a.y + a.h/2, a.color); playExplosionSound();
                    alienSpeed += 0.05;
                }
            });
            if (ufo.active && b.x < ufo.x + ufo.w && b.x + 8 > ufo.x && b.y < ufo.y + ufo.h && b.y + 20 > ufo.y) {
                ufo.active = false; bullets.splice(i, 1); score += 100;
                scoreEl.innerText = score.toString().padStart(6, '0');
                stopUfoSound(); createExplosion(ufo.x + 45, ufo.y + 20, ufo.color, 3); playExplosionSound();
            }
        });

        enemyBullets.forEach((b, i) => {
            b.y += 7; if (b.y > 1100) enemyBullets.splice(i, 1);
            if (player.alive && b.x < player.x + 80 && b.x + 6 > player.x && b.y < player.y + 45 && b.y + 15 > player.y) {
                enemyBullets.splice(i, 1); lives--; livesEl.innerText = lives;
                player.alive = false; createExplosion(player.x + 40, player.y + 20, player.color, 5); 
                playPlayerExplosionSound();
                if (lives > 0) setTimeout(() => { player.alive = true; player.x = 660; }, 1500);
                else setTimeout(endGame, 1000);
            }
        });

        let edge = false;
        let activeAliens = 0;
        aliens.forEach(a => { 
            if (a.alive) { 
                activeAliens++;
                a.x += alienSpeed * alienDir; 
                if (a.x + a.w > 1350 || a.x < 50) edge = true; 
                if (a.y + a.h > player.y) endGame(); 
            } 
        });
        if (edge) { alienDir *= -1; aliens.forEach(a => a.y += 30); }

        if (activeAliens === 0) winGame();

        if (Math.random() < 0.02) {
            const alive = aliens.filter(a => a.alive);
            if (alive.length) { const s = alive[Math.floor(Math.random() * alive.length)]; enemyBullets.push({ x: s.x + s.w/2, y: s.y + s.h }); }
        }
        particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.alpha -= p.decay; if (p.alpha <= 0) particles.splice(i, 1); });
    }

    function draw() {
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0,0,1400,1100);
        ctx.fillStyle = '#fff'; stars.forEach(s => ctx.fillRect(s.x, s.y, s.s, s.s));
        particles.forEach(p => { ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4); });
        ctx.globalAlpha = 1;

        if (player.alive) {
            ctx.shadowBlur = 15; ctx.shadowColor = player.color; ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, 80, 45); ctx.fillRect(player.x + 34, player.y - 15, 12, 15);
        }
        if (ufo.active) {
            ctx.shadowBlur = 30; ctx.shadowColor = ufo.color; ctx.fillStyle = ufo.color;
            ctx.beginPath(); ctx.ellipse(ufo.x + 45, ufo.y + 20, 45, 20, 0, 0, Math.PI * 2); ctx.fill();
        }
        ctx.shadowBlur = 10; ctx.fillStyle = '#fff'; bullets.forEach(b => ctx.fillRect(b.x, b.y, 8, 20));
        ctx.fillStyle = '#FFFF33'; enemyBullets.forEach(b => ctx.fillRect(b.x, b.y, 6, 15));
        aliens.forEach(a => { if (a.alive) drawAlienShape(a); });
        ctx.shadowBlur = 0;
    }

    function winGame() {
        gameActive = false; 
        stopUfoSound(); 
        bgm.pause(); 
        document.getElementById('completeScreen').style.display = 'flex';
    }

    function endGame() { 
        gameActive = false; 
        stopUfoSound(); 
        bgm.pause(); 
        document.getElementById('gameOverScreen').style.display = 'flex'; 
    }

    function resetGame() { 
        score = 0; lives = 3; player.alive = true; gameActive = true; bgm.currentTime = 0; bgm.play();
        scoreEl.innerText = "000000"; livesEl.innerText = lives;
        bullets = []; enemyBullets = []; particles = [];
        document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
        initAliens(); 
    }

    initStars(); initAliens();
    (function loop() { update(); draw(); requestAnimationFrame(loop); })();
</script>
</body>
</html>
